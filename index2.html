<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Git and Hosting Setup</title>
  <!-- Suppress favicon -->
  <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
  <link rel="shortcut icon" href="#" />
  <link rel="stylesheet" href="reset.css" />
  <link rel="stylesheet" href="text.css" />
  <link rel="stylesheet" href="960.css" />
  <script src="modernizr-latest.js"></script>
  <style>
  .success {
    color:green;
  }
  .fail {
    color:red;
  }
  h1 {
    margin:0px;
    padding:0px;
  }
  header div {
    position: relative;
    top: 50%;
    transform: translateY(70%);
  }
  header {
    display: block;
    border-bottom: 1px solid lightgray;
    margin-bottom: 10px;
  }
  section {
    margin-bottom:10px;
  }
  input[type="text"] { width:200px; }
  input[type="email"] { width:200px; }
  input[type="password"] { width:200px; }
  .js #javascript-warning {display: none;}
  #invisible-gravatar {display: none;}
  .github-two-factor {display: none; }
  .gravatar-account { display: none; }
  .webcam { display: none; }
  .manual { display: none; }
  
  .js .no-github-upgraded { display: none; }
  .github-upgraded { display: none; }
  .github-profile { display:none; }
  .github-collaborator {display: none;}
  .github-repository {display: none;}
  .github-key {display: none;}
  
  </style>
  <script src="sparkMD5.js"></script>
  <script src="jquery-2.1.1.min.js"></script>
  <script src="github.js"></script>
<!--  <script>
  // Borrowed from Modernizr, switch no-js to js if javascript is available
  document.documentElement.className=document.documentElement.className.replace(/\bno-js\b/,'') + ' js';
  </script> -->
</head>
<body>
  <article>
    <form method="post" action="/" >
    <!-- How we determine if the user has a Gravatar -->
      <img id="invisible-gravatar" 
      src="http://www.gravatar.com/avatar/EMAIL_HASH?d=404"  />
      
    <!-- Nag the user if JavaScript is disabled -->
      <section class="container_12" id="javascript-warning">
        <header>
            <h1 class="grid_2" style="color:red;"><i class="fa fa-warning fail"></i> Warning</h1>
            <div class="grid_10"><b>This page requires JavaScript
            to setup git and hosting</b></div>
            <div class="clear"></div>
        </header>
        
        <!-- IE users -->
        <div class="grid_2" style="text-align: right;">
            <img src="ie.svg" width="140" height="140"
            title="Internet Explorer" />
        </div>
        <div class="grid_10">
        <!-- IE5 through IE9 -->
        <!--[if lte IE 9]>
            <b>Your browser is obsolete</b>:
            Please <a target="actionRequired"
            href="http://windows.microsoft.com/en-us/internet-explorer/download-ie">upgrade</a>
            first, or install
            <a href="http://www.google.com/chrome/" 
            target="actionRequired">Chrome</a> or 
            <a href="https://www.mozilla.org/en-US/firefox/new/"
            target="actionRequired">Firefox</a> instead<br/><br/>
        <![endif]-->
            If <b>Internet Explorer restricted this webpage from running scripts
            or ActiveX controls</b>, click <b>Allow blocked content</b>
            <ol>
                <li>Otherwise, click <b>Tools</b> and select
                <b>Internet options</b></li>
                <li>Select the <b>Security</b> tab within Internet Options</li>
                <li>Click <b>Custom level...</b></li>
                <li>Scroll until you find the &quot;Scripting&quot; section</li>
                <li>Under &quot;Active Scripting&quot;, click <b>Enable</b></li>
                <li>Click <b>OK</b></li>
                <li>Reload this page</li>
            </ol>
        </div>
        <div class="clear"></div>

        <!-- Chrome users -->
        <div class="grid_2">
            <img src="chrome.svg" width="140" height="140" title="Chrome" />
        </div>
        <div class="grid_10">
            <b>Chrome users</b>: if you installed ScriptSafe or NotScripts,
            enable (allow or trust) JavaScript
            <ol>
                <li>Otherwise, open a new tab and type
                <code>chrome://settings</code> in the location (address) bar</li>
                <li>Click <b>Show advanced settings...</b></li>
                <li>In the "Privacy" section,
                click <b>Content settings...</b></li>
                <li>In the "Javascript" section, select
                <b>Allow all sites to run JavaScript (recommended)</b></li>
                <li>Click <b>Done</b></li>
                <li>Reload this page</li>
            </ol>
        </div>
        <div class="clear"></div>
        <br/>
        
        <!-- Firefox users -->
        <div class="grid_2">
            <a href="http://kb.mozillazine.org/About:config"
            target="actionRequired">
                <img src="firefox.svg" width="140"
                height="140" title="Firefox" />
            </a>
        </div>
        <div class="grid_10">
            <b>Firefox users</b>: if you installed NoScript,
            enable (allow or trust) JavaScript
            <ol>
                <li>Otherwise, open a new tab and type <code>about:config</code>
                in the location (address) bar</li>
                <li>Type <code>javascript.enabled</code> in the <b>Search</b> box</li>
                <li>Double-click to set <code>javascript.enabled</code> to <b>true</b></li>
                <li>Reload this page</li>
            </ol>
        </div>
        <div class="clear"></div>
      </section>
      
      <!-- What to do if the script is offline -->
      <section class="container_12 manual">
        <header>
            <h1 class="grid_2" style="color:red;">Error</h1>
            <div class="grid_10">
                Script off-line: troubleshoot or complete steps manually
            </div>
            <div class="clear"></div>
        </header>
        <div class="grid_2">Troubleshooting</div>
        <div class="grid_3">
            <b>Possible cause</b><br/>
            Firewall is blocking <code>netcat</code>
        </div>
        <div class="grid_7">
            <b>Solution</b><br/>
            <ol>
                <li>Open the firewall</li>
                <li>Allow programs to communicate through the firewall</li>
                <li>Change settings</li>
                <li>Select <code>nc.exe</code> and ensure <b>Domain</b> is checked</li>
                <li>Click <b>OK</b></li>
                <li>Close this window and restart the script in the command line</li>
            </ol>
        </div>
        <div class="clear"></div>
        
        <div class="grid_2">&nbsp;</div>
        <div class="grid_3">
            Another program is using port 8080
        </div>
        <div class="grid_7">
            <ol>
                <li>Close any web servers on your machine</li>
                <li>Close this window and restart the script in the command line</li>
            </ol>
        </div>
      </section>

      <!-- Profile -->
      <section class="container_12">
        <header>
            <h1 class="grid_2">Profile</h1>
            <div class="grid_10">
                Confirm your full name and school email address
            </div>
            <div class="clear"></div>
        </header>
        
        <!-- Full name -->
        <div class="grid_2" style="text-align: right;">
            <label for="name">Full name</label>
        </div>
        <div class="grid_3">
            <input id="name" type="text" name="name" value="FULL_NAME"
            placeholder="Full name" pattern="[^ ]+( [^ ]+)+" required
            title="Full name (first and last)" autocomplete="on" /><br/>
        </div>
        <code class="grid_7"
        id="git-config-name">git config --global user.name "FULL_NAME"</code>
        <div class="clear"></div>
        
        <!-- Email -->
        <div class="grid_2" style="text-align: right;">
            <label for="email">School email</label>
        </div>
        <div class="grid_3">
            <input id="email" type="email" name="email" value="USER_EMAIL"
            placeholder="School email address" required
            autofocus autocomplete="on" title="School email address (ends with .edu)" />
        </div>
        <code class="grid_7"
        id="git-config-email">git config --global user.email USER_EMAIL</code>
        <div class="clear"></div>
     </section>
     
     <!-- Gravatar -->
     <section class="container_12">
        <header>
        <h1 class="grid_2">Gravatar</h1>
        <div class="grid_10">
            Create or update your Gravatar (global profile picture)
            to help the instructor learn names
        </div>
        <div class="clear"></div>
        </header>
        
        <div class="grid_2">
            <img id="visible-gravatar"
            src="http://www.gravatar.com/avatar/EMAIL_HASH?d=retro&s=140"
            title="Your Gravatar" width="140" height="140" />
        </div>
        <div class="grid_3">
            <div class="gravatar-account">
                Thanks for creating a Gravatar!
            </div>
            <div class="no-gravatar-account">
                <b>
                    <a href="https://en.gravatar.com/connect/?source=_signup"
                    target="actionRequired"
                    title="New to Gravatar? Join with your school email">
                        Join</a>
                </b>
                or
                <b>
                    <a href="https://en.gravatar.com/emails/new"
                    target="actionRequired"
                    title="Already use Gravatar? Add and verify your school email">
                        Add &amp; verify school email</a>
                </b>
            </div>
            <div class="gravatar-login">
                <input type="password" id="gravatarPassword"
                placeholder="Gravatar password" pattern=".{7,}" />
                <input type="button" value="Sign in" /> 
                <a href="https://en.wordpress.com/wp-login.php?action=lostpassword&wpcom_connect=1">Forgot password?</a>
            </div>
        </div>
        <div class="grid_7">
            <div class="no-js">
                <a href="https://en.gravatar.com/gravatars/new"
                target="actionRequired"
                title="Update Gravatar profile picture">Update</a>
            </div>
            <div class="webcam">
                How about webcam.js here? http://pixlcore.com/read/WebcamJS
            </div>
        </div>
      </section>
      
      <!-- Github -->
      <section class="container_12">
        <header>
          <h1 class="grid_2">Github</h1>
          <div class="grid_10">
            Github hosts private repositories free for students: 
            <span class="no-github-authenticated">
                create or upgrade your account for educational use
            </span>
            <span class="no-github-upgraded">
                upgrade your account for educational use
            </span>
            <span class="github-upgraded">
                thanks for setting up your account!
            </span>
          </div>
          <div class="clear"></div>
        </header>
        
        <div class="clear"></div>
        <div class="grid_2">
            <img src="http://lawrancej.github.io/starterupper/github.svg"
            width="140" height="140" />
        </div>
        <div class="grid_3">
            <div class="github-authenticated">
                You are signed into Github
                <button>Sign out</button>
            </div>
            <div class="no-github-authenticated">
                <a href="https://github.com/join"
                target="actionRequired"
                title="New to Github? Join with your school email">
                    <b>Join</b></a>
                or 
                <a href="https://github.com/settings/emails"
                target="actionRequired" 
                title="Already use Github? Add and verify your school email">
                    <b>Add &amp; verify school email</b></a>
                <br/>
                
                <input type="text" name="github.login" id="github-login"
                value="GITHUB_LOGIN" placeholder="Github username"
                pattern="^[0-9a-zA-Z][0-9a-zA-Z-]*$"
                title="Github username (must be alphanumeric)" required />
                <br />
                
                <input type="password" id="github-password"
                placeholder="Github password" pattern=".{7,}"
                title="Github password (must be 7+ characters)" required />
                <br />
                
                <div class="github-two-factor">
                    <input type="text" id="otp" placeholder="Authentication code"
                    pattern="[0-9]{6}" required />
                    <br />
                </div>
                <input type="button" onclick="login(this);" value="Sign in" />
                <a href="https://github.com/password_reset">Forgot password?</a>
            </div>
        </div>
        <div class="grid_7">
            <div class="github-authenticated">
                <ul class="fa-ul">
                    <li class="no-github-email-verified">
                        <i class="fa-li fa fa-warning fail"></i>
                        <a href="https://github.com/settings/emails"
                        target="actionRequired">Add &amp; verify
                        your school email</a><br/>(Github will email a link: click it to verify)
                    </li>
                    <li class="no-github-upgraded">
                        <i class="fa-li fa fa-warning fail"></i>
                        <a href="https://education.github.com/discount_requests/new"
                        target="actionRequired">Request an educational discount</a>
                    </li>
                    <li class="no-github-profile">
                        <i class="fa-li fa fa-warning fail"></i>
                        <!-- Only ask the user to do stuff themselves if Javascript's disabled (or failed) and the server's dead (or failed) -->
                        <a target="actionRequired"
                        href="https://github.com/settings/profile">
                            Share your name with Github</a>
                    </li>
                    <li class="github-profile">
                        <i class="fa-li fa fa-check success"></i>
                        Shared your name with Github
                        (<a target="actionRequired"
                        href="https://github.com/settings/profile">Update profile</a>)
                    </li>
                    <li class="no-github-repository">
                        <i class="fa-li fa fa-warning fail"></i>
                        <a target="actionRequired" href="https://github.com/new">
                            Create private repository REPOSITORY</a>
                    </li>
                    <li class="github-repository">
                        <i class="fa-li fa fa-check success"></i>
                        Created private repository
                        <a href="#" target="actionRequired">REPOSITORY</a>
                    </li>
                    <li class="no-github-collaborator">
                        <i class="fa-li fa fa-warning fail"></i>
                        Add INSTRUCTOR_GITHUB as a collaborator for REPOSITORY
                    </li>
                    <li class="github-collaborator">
                        <i class="fa-li fa fa-check success"></i>
                        <a href="#" target="actionRequired">
                            Added INSTRUCTOR_GITHUB as a collaborator for REPOSITORY</a>
                    </li>
                    <li class="no-github-key">
                        <i class="fa-li fa fa-warning fail"></i>
                        <a href="https://github.com/settings/ssh"
                        target="actionRequired">Share public key</a><br/>
                        <textarea>PUBLIC_KEY</textarea>
                    </li>
                    <li class="github-key">
                        <i class="fa-li fa fa-check success"></i>
                        Shared public key
                        (<a href="https://github.com/settings/ssh"
                        target="actionRequired">Update</a>)
                    </li>
                </ul>
            </div>
        </div>
      </section>
      <section class="container_12">
        <header>
          <h1 class="grid_2">Git Setup</h1>
          <div class="grid_10">Set up your git repositories: <b>local</b> (<a href="{{localRepo}}" target="_blank"><code>~/{{repo}}</code></a>), <b>origin</b> (<a href="https://github.com/{{githubUsername}}/{{repo}}" target="_blank">your private repository</a>), and <b>upstream</b> (<a href="https://github.com/{{githubInstructorLogin}}/{{repo}}" target="_blank">course repository</a>)</div>
          <div class="clear"></div>
        </header>
        <div class="clear"></div>
        <div class="grid_2"><img src="http://lawrancej.github.io/starterupper/git.svg" width="140" height="140" /></div>
        <div class="grid_10">
          <button>Set up {{repo}}</button>
          <pre>git clone https://github.com/{{githubInstructorLogin}}/{{repo}}.git
cd {{repo}}
git remote rm origin
git remote add origin git@github.com:{{githubUsername}}/{{repo}}.git
git remote add upstream https://github.com/{{githubInstructorLogin}}/{{repo}}.git
git push -u origin master</pre>
        </div>
      </section>
    </form>
  </article>
  <script>
    var model = {
        // Name of the repository only
        repo: 'REPOSITORY',
        // file:// path to local repository
        localRepo: 'LOCAL_REPO',

        // User's full name
        fullName: 'FULL_NAME',
        // User's OS username
        localUsername: 'USER_NAME',
        // User's login at their machine
        hostLogin: 'USER_NAME@HOSTNAME',
        // User's public key
        publicKey: 'PUBLIC_KEY',
        
        // User's email (DO NOT set directly, use model.setEmail())
        email: 'USER_EMAIL',
        // Sanitize email address before setting it
        setEmail: function(address) {
            this.email = address.toLowerCase().trim();
        },
        // Is the user's email valid?
        validEmail: function() {
            var regex = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
            return regex.test(this.email);
        },
        // Is the user's email a school email?
        schoolEmail: function() {
            var regex = /edu$/;
            return regex.test(this.email);
        },
        // Gravatar ID
        gravatarId: function() {
            return SparkMD5.hash(this.email);
        },
        
        // What's the username?
        githubLogin: 'GITHUB_LOGIN',
        githubPassword: '',
        // Who's the instructor?
        githubInstructorLogin: 'INSTRUCTOR_GITHUB',
    };

    var controller = {
        name: function() {
            model.fullName = $("#name").val();
            $( "#git-config-name" ).html('git config --global user.name "' + model.fullName + '"');
        },
        email: function() {
            model.setEmail($("#email").val());
            $( "#git-config-email" ).html('git config --global user.email ' + model.email);
            
            this.gravatar(model.validEmail && model.schoolEmail);
            $("#invisible-gravatar").attr('src', 'http://www.gravatar.com/avatar/' + model.gravatarId() + '?d=404');
            $("#visible-gravatar").attr('src', 'http://www.gravatar.com/avatar/' + model.gravatarId() + '?d=retro&s=140');
        },
        // Show class and hide its opposite
        update: function(klass, value) {
            if (value) {
                $('.'+klass).show();
                $('.no-'+klass).hide();
            } else {
                $('.'+klass).hide();
                $('.no-'+klass).show();
            }
        },
        gravatar: function(value) {
            this.update('gravatar-account',value);
        },
        github: function() {
            model.githubLogin = $("#github-login").val();
            model.githubPassword = $("#github-password").val();
            if (Github.authenticated()) {
                setupUser();
                setupEmail();
//                setupSSH();
                setupRepo();
                controller.update('github-authenticated', true);
            }
        },
    };
    $( "#name" ).on( "change", function( event ) {
        controller.name();
    });
    $( "#email" ).on( "change", function( event ) {
        controller.email();
    });
    $( "#github-login" ).on( "change", function( event) {
        controller.github();
    });
    $( "#github-password" ).on( "change", function( event) {
        controller.github();
    });
    $( "#invisible-gravatar" ).on( "error", function( event ) {
        controller.gravatar(false);
    });
    $(function() {
        controller.name();
        controller.email();
        controller.github();
    });
  </script>

  <script>
    function setupUser() {
        // Nag the user if they're not on an upgraded plan
        Github.getUser({
            success: function(response) {
                controller.update('github-upgraded', (response.plan.name.toLowerCase() != "free"));
            }
        });
        Github.setUser({
            data: {
                name: model.fullName
            },
            success: function(response) {
                controller.update('github-profile',true);
            },
            fail: function(response) {
                controller.update('github-profile',false);
            }
        });
        // Set the company for the instructor's benefit
        // (if a company isn't already set)
        // TODO: http://www.whoisxmlapi.com/whois-api-doc.php
        /*
        if (response.hasOwnProperty("company") && response.company == "") {
            Github.setUser({
                data: {company: ""},
                success: function(response) {},
                fail: function(response) {
                // TODO: tell the user what to do if this breaks
                }
            });
        }
        */
    }
    function setupEmail() {
        // Setup email
        Github.getEmail({
            email: model.email,
            added: function() {
                controller.update('github-email-found',true);
            },
            verified: function() {
                controller.update('github-email-verified',true);
            },
            unverified: function() {
                controller.update('github-email-verified',false);
            },
            missing: function() {
                // The user needs to verify their email
                controller.update('github-email-verified',false);
                Github.setEmail({
                    email: model.email,
                    success: function() {
                        controller.update('github-email-found',true);
                    },
                    fail: function() {
                        controller.update('github-email-found',false);
                    }
                });
            }
        });
    }
    function setupSSH() {
        Github.shareKey({
            title: model.hostLogin,
            key: model.publicKey,
            success: function() {
                controller.update('github-key',true);
            },
            fail: function() {
                controller.update('github-key',false);
            }
        });
    }
    function setupRepo() {
        Github.createRepo({
            login: model.githubLogin,
            repo: model.repo,
            success: function(response) {
                controller.update('github-repository',true);
            },
            fail: function(response) {
                controller.update('github-repository',false);
            }
        });
        Github.addCollaborator({
            login: model.githubLogin,
            repo: model.repo,
            collaborator: model.githubInstructorLogin,
            success: function(response) {
                controller.update('github-collaborator', true);
            },
            fail: function(response) {
                controller.update('github-collaborator', false);
            }
        });
    }
    function login(event) {
        model.githubLogin = $("#github-login").val();
        model.githubPassword = $("#github-password").val();
        Github.login({
            username: model.githubLogin,
            password: model.githubPassword,
            otp: $("#otp").val(),
            authenticated: function() {
                controller.update('github-authenticated', true);
                setupUser();
                setupEmail();
//                setupSSH();
                setupRepo();
            },
            badCredential: function() {
                // Clear the password
                $("#password").attr('value', '');
                controller.github();
            },
            twoFactor: function() {
                $('.github-two-factor').show();
            }
        });
    }
  </script>
</body>
</html>